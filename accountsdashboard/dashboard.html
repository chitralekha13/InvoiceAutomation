<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Management - Accounts Portal</title>
    <script src="config.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
      if (/^localhost$|^127\.0\.0\.1$/i.test(window.location.hostname)) {
        var s = document.createElement('script'); s.src = 'config.local.js'; s.onerror = function() { this.remove(); }; document.head.appendChild(s);
      }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        .header {
            background: #1e3a5f;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-title { color: white; font-size: 20px; font-weight: 600; }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .btn-hamburger {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.6);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            display: flex; flex-direction: column; justify-content: center; gap: 4px;
        }
        .btn-hamburger:hover { background: rgba(255,255,255,0.15); }
        .btn-hamburger span { display: block; width: 22px; height: 2px; background: white; }
        .header-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            min-width: 200px;
            z-index: 1000;
            overflow: hidden;
        }
        .header-dropdown.show { display: block; }
        .header-dropdown a, .header-dropdown button, .header-dropdown label { display: block; width: 100%; padding: 12px 16px; text-align: left; border: none; background: none; color: #333; font-size: 14px; cursor: pointer; font-family: inherit; box-sizing: border-box; }
        .header-dropdown a:hover, .header-dropdown button:hover, .header-dropdown label:hover { background: #f0f4f8; }
        .header-dropdown-wrap { position: relative; }
        .dropdown-divider { border: none; border-top: 1px solid #eee; margin: 4px 0; }

        /* Upload option in dropdown */
        .dropdown-upload-label { display: flex !important; align-items: center; gap: 8px; cursor: pointer; width: 100%; padding: 12px 16px; color: #333; font-size: 14px; box-sizing: border-box; }
        .dropdown-upload-label:hover { background: #f0f4f8; }
        .dropdown-upload-label input[type="file"] { display: none; }
        .upload-icon { font-size: 16px; }

        .btn-logout {
            background: transparent;
            color: white;
            border: 1px solid rgba(255,255,255,0.6);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin-right: 12px;
        }
        .btn-logout:hover { background: rgba(255,255,255,0.1); }

        .filter-bar {
            background: #e8e9ec;
            padding: 14px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .filter-left { display: flex; gap: 16px; align-items: center; }

        .filter-left select, .filter-left input {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .filter-left label { font-size: 14px; color: #555; margin-right: 6px; }
        .btn-refresh {
            background: #0078d4;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-refresh:hover { background: #005a9e; }
        .btn-refresh:disabled { background: #90b8d8; cursor: not-allowed; }

        .main { padding: 24px; max-width: 1800px; margin: 0 auto; }
        .metrics-row {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .metric-card .value {
            font-size: 28px;
            font-weight: 600;
            color: #333;
        }
        .metric-card.amount .value { color: #0078d4; }
        .metric-card .label {
            font-size: 13px;
            color: #666;
            margin-top: 6px;
        }
        .metric-card.clickable {
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
        }
        .metric-card.clickable:hover {
            background: #f0f4f8;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        }
        .metric-card.clickable.active {
            background: #1e3a5f;
            color: white;
        }
        .metric-card.clickable.active .value,
        .metric-card.clickable.active .label { color: white; }


        .pane-headers {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0;
            margin-bottom: 0;
            background: #f8f9fa;
            border-radius: 6px 6px 0 0;
            overflow: hidden;
            border: 1px solid #dee2e6;
            border-bottom: none;
        }
        .pane-header {
            padding: 16px 24px;
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            transition: background 0.2s, color 0.2s;
        }
        .pane-header:last-child { border-right: none; }
        .pane-header:hover { background: #e9ecef; color: #1e3a5f; }
        .pane-header.active {
            background: white;
            color: #1e3a5f;
            border-bottom: 2px solid white;
            margin-bottom: -1px;
        }
        .panes-wrapper { border: 1px solid #dee2e6; border-top: none; border-radius: 0 0 6px 6px; overflow: hidden; }
        .pane {
            background: white;
            box-shadow: none;
            border-radius: 0;
            display: none;
            overflow: hidden;
        }
        .pane.active { display: block; }
        .pane-title {
            padding: 16px 24px;
            font-size: 18px;
            font-weight: 600;
            color: #333;
            border-bottom: 1px solid #eee;
        }
        .pane-body { padding: 20px 24px; }

        .sow-placeholder { color: #666; font-size: 14px; }

        .table-section {
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .table-title {
            padding: 16px 24px;
            font-size: 18px;
            font-weight: 600;
            color: #333;
            border-bottom: 1px solid #eee;
        }
        .table-wrapper { overflow-x: auto; }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        th {
            background: #f8f9fa;
            padding: 12px 14px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #dee2e6;
        }
        td {
            padding: 12px 14px;
            border-bottom: 1px solid #eee;
            color: #444;
        }
        tr:hover { background: #f8f9fa; }
        .editable {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 2px;
        }
        .editable:hover { background: #e7f3ff; }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .user-name { color: rgba(255,255,255,0.9); font-size: 14px; }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1e3a5f;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .checkbox-col { width: 90px; text-align: left; padding-left: 8px; }
        .checkbox-col .row-delete-btn {
            margin-left: 8px;
            background: none;
            border: none;
            color: #d13438;
            cursor: pointer;
            font-size: 12px;
            padding: 0 4px;
            display: none;
        }
        .checkbox-col .row-delete-btn.show { display: inline; }
        .checkbox-col .row-delete-btn:hover { text-decoration: underline; }
        .actions-col { width: 180px; text-align: center; white-space: nowrap; }

        .btn-view-payment {
            background: #107c10;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 4px;
        }
        .btn-view-payment:hover { background: #0e6b0e; }
        .btn-payment-done {
            background: #d83b01;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 4px;
        }
        .btn-payment-done.done {
            background: #0078d4;
        }
        tr.row-payment-done {
            background-color: #e0f5e0 !important;
        }
        .payment-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .payment-modal-content {
            background: white;
            padding: 24px;
            border-radius: 8px;
            max-width: 600px;
            max-height: 80vh;
            overflow: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .payment-modal h3 { margin-bottom: 12px; color: #333; }
        .payment-modal-body { background: #f8f9fa; padding: 16px; border-radius: 4px; overflow-x: auto; font-size: 13px; }
        .payment-details-table { width: 100%; border-collapse: collapse; }
        .payment-details-table td { padding: 8px 12px; border-bottom: 1px solid #e0e0e0; vertical-align: top; }
        .payment-details-table .payment-label { font-weight: 600; color: #444; width: 40%; }
        .payment-details-table .payment-value { color: #333; }
        .payment-details-table .payment-section { font-weight: 600; color: #1e3a5f; padding-top: 12px; }
        .payment-pre { white-space: pre-wrap; margin: 0; font-family: inherit; }
        .payment-modal-close { float: right; background: #666; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        .payment-modal-footer { margin-top: 16px; padding-top: 12px; border-top: 1px solid #eee; }
        .btn-payment-done-modal {
            background: #107c10;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-payment-done-modal:hover { background: #0e6b0e; }
        .btn-payment-done-modal.done { background: #2e7d32; cursor: default; }
        .btn-view {
            background: #28a745; 
            color: white; 
            border: none;
            padding: 8px 15px; 
            border-radius: 3px; 
            cursor: pointer; 
            font-size: 12px;
        }

        .btn-view:hover { 
            background: #218838; 
        }

        #viewerOverlay {
            display: none;
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: flex-end;
            align-items: stretch;
        }

        #viewerPanel {
            width: 60%;
            background: #fff;
            display: flex;
            flex-direction: column;
            box-shadow: -4px 0 24px rgba(0,0,0,0.2);
        }

        #viewerHeader {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            border-bottom: 1px solid #dee2e6;
            background: #f8f9fa;
            gap: 12px;
            flex-shrink: 0;
        }

        #viewerFileName {
            font-size: 14px; font-weight: 600;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }

        #viewerActions { display: flex; gap: 8px; flex-shrink: 0; }

        .viewer-btn {
            padding: 7px 16px; border-radius: 5px;
            border: none; cursor: pointer; font-size: 13px; font-weight: 500;
        }

        .viewer-btn-download { background: #0078d4; color: #fff; }
        .viewer-btn-download:hover { background: #006cbf; }
        .viewer-btn-close { background: #fff; color: #333; border: 1px solid #ccc; }
        .viewer-btn-close:hover { background: #f0f0f0; }

        #pdfContainer {
            flex: 1;
            overflow-y: auto;
            background: #525659;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        /* Excel Upload progress toast */
        .toast { position: fixed; bottom: 24px; right: 24px; background: #1e3a5f; color: white; padding: 14px 20px; border-radius: 6px; font-size: 14px; box-shadow: 0 4px 16px rgba(0,0,0,0.2); z-index: 3000; display: none; max-width: 360px; }
        .toast.show { display: block; }
        .toast-title { font-weight: 600; margin-bottom: 6px; }
        .toast-body { opacity: 0.85; font-size: 13px; line-height: 1.5; }
        .toast-close { float: right; cursor: pointer; font-size: 16px; line-height: 1; margin-left: 12px; opacity: 0.7; }
        .toast-close:hover { opacity: 1; }
        .toast.success { background: #107c10; }
        .toast.error   { background: #d13438; }
        .toast.warning { background: #ca5010; }

        .sync-results { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 16px 20px; margin: 0 24px 16px; font-size: 13px; }
        .sync-results-title { font-weight: 600; color: #1e3a5f; margin-bottom: 10px; font-size: 14px; }
        .sync-stat { display: inline-block; margin: 0 12px 6px 0; padding: 3px 10px; border-radius: 12px; font-weight: 600; font-size: 12px; }
        .sync-stat.green  { background: #d4edda; color: #155724; }
        .sync-stat.amber  { background: #fff3cd; color: #856404; }
        .sync-stat.red    { background: #f8d7da; color: #721c24; }
        .sync-stat.blue   { background: #cce5ff; color: #004085; }
        .sync-stat.grey   { background: #e2e3e5; color: #383d41; }

    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="header-dropdown-wrap">
                <button type="button" class="btn-hamburger" id="btnHamburger"
                        onclick="toggleHeaderMenu()" aria-label="Menu">
                    <span></span><span></span><span></span>
                </button>
                <div class="header-dropdown" id="headerDropdown">
                    <button type="button" onclick="window.open('users.html','_blank'); closeHeaderMenu();">
                        Manage users
                    </button>
                    <button type="button" onclick="generateDailySummary(); closeHeaderMenu();">
                        Generate daily summary
                    </button>
                    <hr class="dropdown-divider">
                    <input type="file" id="syncExcelInput" accept=".xlsx,.xls"
                        style="display:none" onchange="onSyncFileChosen(this)">
                    <button type="button" onclick="document.getElementById('syncExcelInput').click();">
                        ðŸ“¤ Sync Excel â†’ Approved Hours
                    </button>
                </div>
            </div>
            <span class="header-title">Accounts Invoice Dashboard</span>
        </div>
        <div class="user-info">
            <span class="user-name" id="userName"></span>
            <button type="button" class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="filter-bar">
        <div class="filter-left">
            <label for="filterAll">All</label>
            <select id="filterAll">
                <option value="all">All</option>
                <option value="pending">Pending</option>
                <option value="complete">Complete</option>
                <option value="need_approval">Need Approval</option>
                <option value="payment_initiated">Payment Initiated</option>
            </select>
            <label for="dueBy">Due by</label>
            <input type="date" id="dueBy" placeholder="mm/dd/yyyy">
        </div>
        <div style="display:flex;gap:12px;align-items:center;">
            <button class="btn-refresh" onclick="loadDashboard()">Refresh</button>
            <button class="btn-refresh" onclick="downloadExcel()">Download Excel</button>
        </div>
    </div>

    <div class="main">
        <div class="metrics-row">
            <div class="metric-card clickable" id="tileTotal" data-filter="all" onclick="filterByTile('all')"><div class="value" id="mTotal">0</div><div class="label">Total</div></div>
            <div class="metric-card clickable" id="tilePending" data-filter="pending" onclick="filterByTile('pending')"><div class="value" id="mPending">0</div><div class="label">Pending</div></div>
            <div class="metric-card clickable" id="tilePaymentInitiated" data-filter="payment_initiated" onclick="filterByTile('payment_initiated')"><div class="value" id="mPaymentInitiated">0</div><div class="label">Payment Initiated</div></div>
            <div class="metric-card clickable" id="tileComplete" data-filter="complete" onclick="filterByTile('complete')"><div class="value" id="mComplete">0</div><div class="label">Complete</div></div>
            <div class="metric-card amount"><div class="value" id="mTotalAmount">$0.00</div><div class="label">Total Amount</div></div>
            <div class="metric-card clickable" id="tileNeedApproval" data-filter="need_approval" onclick="filterByTile('need_approval')"><div class="value" id="mNeedApproval">0</div><div class="label">NEED APPROVAL</div></div>
        </div>
        <div class="sync-results" id="syncResultsPanel" style="display:none"></div>
        <div class="pane-headers">
            <div class="pane-header active" data-pane="invoices" onclick="switchPane('invoices')">Invoice Management Table</div>
            <!--<div class="pane-header" onclick="window.open('users.html', '_blank')">Manage Users</div>-->
            <div class="pane-header" data-pane="sow" onclick="switchPane('sow')">SOW Info</div>
        </div>
        <div class="panes-wrapper">
            <div class="pane table-section active" id="pane-invoices">
                <div class="table-title">Invoice Management Table</div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th class="checkbox-col"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                <th>S.No</th>
                                <th>ID (UUID)</th>
                                <th>Doc Name</th>
                                <th>Invoice No</th>
                                <th>Consultancy Name</th>
                                <th>Resource Name</th>
                                <th>Division</th>
                                <th>Client Name</th>
                                <th>Pay Period Start</th>
                                <th>Pay Period End</th>
                                <th>Net Terms</th>
                                <th>Vendor Hours</th>
                                <th>Approved Hours</th>
                                <th>Status</th>
                                <th>Pay Rate</th>
                                <th>Invoice Amount</th>
                                <th>Date Inv Recd</th>
                                <th>Due Date</th>
                                <th>Project Name</th>
                                <th>Project Name (Excel)</th>
                                <th>Payment initiated on</th>
                                <th>Actions</th>
                                <th>Document</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="pane" id="pane-sow">
                <div class="pane-title">SOW Info</div>
                <div class="pane-body">
                    <p class="sow-placeholder">SOW information will be displayed here.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay" style="display:none">
        <div class="spinner"></div>
    </div>

    <div class="toast" id="toast">
        <span class="toast-close" onclick="hideToast()">âœ•</span>
        <div class="toast-title" id="toastTitle"></div>
        <div class="toast-body"  id="toastBody"></div>
    </div>

    <div id="paymentModal" class="payment-modal" style="display:none" onclick="if(event.target===this)closePaymentModal()">
        <div class="payment-modal-content">
            <button type="button" class="payment-modal-close" onclick="closePaymentModal()">Close</button>
            <h3>Payment Information</h3>
            <div id="paymentModalContent" class="payment-modal-body"></div>
            <div class="payment-modal-footer">
                <button type="button" id="btnModalPaymentDone" class="btn-payment-done-modal" onclick="markPaymentDoneFromModal()" style="display:none">Payment Done</button>
            </div>
        </div>
    </div>

    <div id="viewerOverlay">
    <div id="viewerPanel">
        <div id="viewerHeader">
            <span id="viewerFileName"></span>
            <div id="viewerActions">
                <button class="viewer-btn viewer-btn-download" id="btnDownload">Download</button>
                <button class="viewer-btn viewer-btn-close"    id="btnClose">Close</button>
            </div>
        </div>
        <div id="pdfContainer"></div>
    </div>
</div>

    <script>
        const accessToken = sessionStorage.getItem('accessToken');
        let currentDocId   = null;
        let currentDocName = null;
        let currentBlobUrl = null;

        let API_BASE = (window.APP_CONFIG && window.APP_CONFIG.apiBaseUrl) || '';
        API_BASE = (API_BASE || '').trim().replace(/\/+$/, '');
        // Force https to avoid Mixed Content and bad configs
        if (API_BASE && !/^https?:\/\//i.test(API_BASE)) API_BASE = 'https://' + API_BASE;
        if (API_BASE && API_BASE.startsWith('http://')) API_BASE = 'https://' + API_BASE.slice(7);

        const userEmail = sessionStorage.getItem('userEmail');
        const userName = sessionStorage.getItem('userName');
        const loggedIn = sessionStorage.getItem('loggedIn');

        if (!loggedIn && !userName) {
            window.location.href = 'index.html';
        }

        function setDisplayName(firstLast) {
            const el = document.getElementById('userName');
            if (el) el.textContent = firstLast || userEmail || '';
        }

        setDisplayName(userName && userName !== userEmail ? userName : userEmail);
        loadDisplayNameFromUsers();

        async function loadDisplayNameFromUsers() {
            const email = sessionStorage.getItem('userEmail');
            if (!email || !API_BASE) return;
            try {
                const res = await fetch(API_BASE + '/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'list' })
                });
                if (!res.ok) return;
                const data = await res.json().catch(() => ({}));
                const users = data.users || [];
                const me = users.find(u => (u.email || '').toLowerCase() === (email || '').toLowerCase());
                if (me && (me.firstname != null || me.lastname != null)) {
                    const full = [me.firstname, me.lastname].filter(Boolean).join(' ').trim();
                    if (full) setDisplayName(full);
                }
            } catch (_) { }
        }

        function toggleHeaderMenu() {
            document.getElementById('headerDropdown').classList.toggle('show');
        }
        function closeHeaderMenu() {
            document.getElementById('headerDropdown').classList.remove('show');
        }
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.header-dropdown-wrap')) closeHeaderMenu();
        });

        let allRows = [];
        let filteredRows = [];
        let excelUrl = '';

        window.addEventListener('load', () => { loadDashboard(); });

        function switchPane(paneId) {
            document.querySelectorAll('.pane-header').forEach(h => h.classList.remove('active'));
            document.querySelectorAll('.pane').forEach(p => p.classList.remove('active'));
            const header = document.querySelector('.pane-header[data-pane="' + paneId + '"]');
            const pane = document.getElementById('pane-' + paneId);
            if (header) header.classList.add('active');
            if (pane) pane.classList.add('active');
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        async function loadDashboard() {
            showLoading(true);
            try {
                if (!API_BASE) {
                    throw new Error('API base URL not configured (config.js missing or apiBaseUrl empty)');
                }
                const res = await fetch(API_BASE + '/api/dashboard/data', {
                    method: 'GET'
                });
                const contentType = res.headers.get('Content-Type') || '';
                const isJson = contentType.toLowerCase().includes('application/json');
                const data = isJson ? await res.json().catch(() => ({})) : {};
                if (!res.ok) {
                    const msg = data.error || res.statusText || 'Failed to load dashboard data';
                    throw new Error(msg);
                }
                if (!isJson || (data.rows === undefined && !data.error)) {
                    throw new Error('API did not return JSON. Check that ' + API_BASE + ' is the correct Function App URL and CORS is enabled.');
                }
                allRows = data.rows || [];
                excelUrl = data.excelUrl || '';
                applyFilters();
                renderMetrics(data.metrics || {});
                renderTable();
                updateTileActiveState();
            } catch (err) {
                console.error('Dashboard load error:', err);
                alert('Dashboard failed: ' + (err.message || 'Check API URL and network.'));
            } finally {
                showLoading(false);
            }
        }

        function renderMetrics(m) {
            document.getElementById('mTotal').textContent = m.total ?? 0;
            document.getElementById('mPending').textContent = m.pending ?? 0;
            document.getElementById('mPaymentInitiated').textContent = m.payment_initiated ?? 0;
            document.getElementById('mComplete').textContent = m.complete ?? 0;
            document.getElementById('mTotalAmount').textContent = '$' + ((m.total_amount ?? 0) / 1).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            document.getElementById('mNeedApproval').textContent = m.need_approval ?? 0;
        }

        function filterByTile(filterValue) {
            document.getElementById('filterAll').value = filterValue;
            updateTileActiveState();
            applyFilters();
            renderTable();
        }

        function updateTileActiveState() {
            const statusFilter = document.getElementById('filterAll').value;
            document.querySelectorAll('.metric-card.clickable').forEach(el => {
                el.classList.toggle('active', el.dataset.filter === statusFilter);
            });
        }

        function applyFilters() {
            filteredRows = [...allRows];
            const statusFilter = document.getElementById('filterAll').value;
            if (statusFilter === 'payment_initiated') {
                filteredRows = filteredRows.filter(r => r.bill_pay_initiated_on);
            } else if (statusFilter !== 'all') {
                filteredRows = filteredRows.filter(r => {
                    const s = (r.approval_status || r.status || '').toLowerCase().replace(/\s/g, '_');
                    return s === statusFilter;
                });
            }
            const dueBy = document.getElementById('dueBy').value;
            if (dueBy) {
                filteredRows = filteredRows.filter(r => {
                    const d = r.due_date || r.dueDate || '';
                    return d && d.toString().slice(0, 10) <= dueBy;
                });
            }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            if (filteredRows.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="19" style="text-align:center;padding:24px;color:#666;">No invoices to display. Upload invoices via the Vendor Portal or check that the API and database are connected.</td>';
                tbody.appendChild(tr);
                return;
            }
            filteredRows.forEach((row, idx) => {
                const id = row.invoice_uuid || row.invoice_id || '';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="checkbox-col">
                        <input type="checkbox" class="row-select" data-id="${id}">
                        <button type="button" class="row-delete-btn" data-id="${id}">Delete</button>
                    </td>
                    <td>${idx + 1}</td>
                    <td title="${id}">${id ? id.slice(0, 8) + '...' : ''}</td>
                    <td>${escapeHtml(row.doc_name || '')}</td>
                    <td class="editable" data-field="invoice_number" data-id="${id}">${escapeHtml(row.invoice_number || '')}</td>
                    <td class="editable" data-field="consultancy_name" data-id="${id}">${escapeHtml(row.vendor_name || row.consultancy_name || '')}</td>
                    <td class="editable" data-field="resource_name" data-id="${id}">${escapeHtml(row.resource_name || '')}</td>
                    <td class="editable" data-field="division"          data-id="${id}">${escapeHtml(row.division || '')}</td>
                    <td class="editable" data-field="client_name"       data-id="${id}">${escapeHtml(row.client_name || '')}</td>
                    <td class="editable" data-field="pay_period_start" data-id="${id}">${formatDate(row.pay_period_start)}</td>
                    <td class="editable" data-field="pay_period_end" data-id="${id}">${formatDate(row.pay_period_end)}</td>
                    <td class="editable" data-field="net_terms" data-id="${id}">${escapeHtml(row.net_terms || '')}</td>
                    <td class="editable" data-field="vendor_hours" data-id="${id}">${row.vendor_hours ?? row.invoice_hours ?? ''}</td>
                    <td class="editable" data-field="approved_hours" data-id="${id}">${row.approved_hours ?? ''}</td>
                    <td>${escapeHtml(row.approval_status || row.status || 'Pending')}</td>
                    <td class="editable" data-field="pay_rate" data-id="${id}">${row.pay_rate ?? ''}</td>
                    <td class="editable" data-field="invoice_amount" data-id="${id}">${row.invoice_amount != null ? formatNumber(row.invoice_amount) : ''}</td>
                    <td>${formatDateTime(row.invoice_received_date || row.date_inv_recd || row.created_at)}</td>
                    <td class="editable" data-field="due_date" data-id="${id}">${formatDate(row.due_date || row.dueDate)}</td>
                    <td class="editable" data-field="project_name" data-id="${id}">${escapeHtml(row.project_name || '')}</td>
                    <td class="editable" data-field="project_name_excel" data-id="${id}">${escapeHtml(row.project_name_excel || '')}</td>
                    <td>${row.bill_pay_initiated_on ? formatDateTime(row.bill_pay_initiated_on) : 'â€”'}</td>
                    <td class="actions-col" data-invoice-id="${escapeHtml(id)}">
                        ${isCompleteRow(row) ? '<button type="button" class="btn-view-payment">View Payment</button>' : ''}
                    </td>
                    <td>
                        <button class="btn-view"
                            data-id="${escapeAttr(row.invoice_uuid || row.invoice_id || row.id || '')}"
                            data-name="${escapeAttr(row.doc_name || row.name || '')}">
                            View / Download
                        </button>
                    </td>
                `;
                if (row.bill_pay_initiated_on) {
                    tr.classList.add('row-payment-done');
                }
                tbody.appendChild(tr);
            });
            bindEditableCells();
            bindActionButtons();
            bindRowSelectDelete();
        }

        /** View Payment only when iGentic has confirmed approved hours match vendor hours (status from iGentic). */
        function isCompleteRow(row) {
            const s = (row.approval_status || row.status || '').toLowerCase();
            return s === 'complete' || s === 'ready for payment' || s === 'approved';
        }

        function formatPaymentLabel(key) {
            return String(key)
                .replace(/_/g, ' ')
                .replace(/([A-Z])/g, ' $1')
                .replace(/^\s+|\s+$/g, '')
                .replace(/\b\w/g, function(c) { return c.toUpperCase(); });
        }

        function renderPaymentDetailsAsHtml(details) {
            if (details == null || typeof details !== 'object') return '';
            const rows = [];
            function add(obj, prefix) {
                for (const [k, v] of Object.entries(obj)) {
                    if (v == null) continue;
                    const label = formatPaymentLabel(k);
                    if (typeof v === 'object' && v !== null && !Array.isArray(v) && (typeof v.getMonth !== 'function')) {
                        rows.push('<tr><td colspan="2" class="payment-section">' + escapeHtml(label) + '</td></tr>');
                        add(v, prefix + k + '.');
                    } else {
                        const val = Array.isArray(v) ? v.join(', ') : String(v);
                        rows.push('<tr><td class="payment-label">' + escapeHtml(label) + '</td><td class="payment-value">' + escapeHtml(val) + '</td></tr>');
                    }
                }
            }
            add(details, '');
            return rows.length ? '<table class="payment-details-table">' + rows.join('') + '</table>' : '';
        }

        let currentPaymentModalInvoiceId = null;

        function viewPaymentInfo(invoiceId) {
            currentPaymentModalInvoiceId = invoiceId;
            const row = allRows.find(r => (r.invoice_uuid || r.invoice_id) === invoiceId);
            const el = document.getElementById('paymentModalContent');
            const btnDone = document.getElementById('btnModalPaymentDone');
            if (!el) return;
            if (!row) {
                el.innerHTML = '<p>Invoice not found.</p>';
                if (btnDone) btnDone.style.display = 'none';
            } else if (row.payment_details && String(row.payment_details).trim()) {
                const raw = row.payment_details.trim();
                let html = '';
                try {
                    const parsed = typeof raw === 'string' && (raw.startsWith('{') || raw.startsWith('[')) ? JSON.parse(raw) : raw;
                    if (typeof parsed === 'object' && parsed !== null) {
                        html = renderPaymentDetailsAsHtml(parsed);
                    }
                } catch (_) {}
                if (html) {
                    el.innerHTML = html;
                } else {
                    el.innerHTML = '<pre class="payment-pre">' + escapeHtml(raw) + '</pre>';
                }
                if (btnDone) {
                    btnDone.style.display = 'inline-block';
                    btnDone.textContent = row.bill_pay_initiated_on ? 'Done' : 'Payment Done';
                    btnDone.classList.toggle('done', !!row.bill_pay_initiated_on);
                    btnDone.disabled = !!row.bill_pay_initiated_on;
                }
            } else {
                el.innerHTML = '<p>No payment details stored yet. Payment details are generated when approved hours are submitted and verified via iGentic (hours match).</p>';
                if (btnDone) btnDone.style.display = 'none';
            }
            document.getElementById('paymentModal').style.display = 'flex';
        }

        function closePaymentModal() {
            const modal = document.getElementById('paymentModal');
            if (modal) modal.style.display = 'none';
        }

        function bindActionButtons() {
            document.querySelectorAll('.btn-view-payment').forEach(btn => {
                btn.onclick = function(e) {
                    e.stopPropagation();
                    const td = this.closest('.actions-col');
                    const id = td && td.dataset.invoiceId;
                    if (id) viewPaymentInfo(id);
                };
            });
        }

        async function markPaymentDoneFromModal() {
            const id = currentPaymentModalInvoiceId;
            if (!id) return;
            const btn = document.getElementById('btnModalPaymentDone');
            if (btn && btn.disabled) return;
            try {
                const res = await fetch(API_BASE + '/api/fcfigures/' + encodeURIComponent(id) + '/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ payment_done: true })
                });
                const data = res.ok ? await res.json().catch(() => ({})) : {};
                if (res.ok && data.invoice) {
                    const row = allRows.find(r => (r.invoice_uuid || r.invoice_id) === id);
                    if (row) Object.assign(row, data.invoice);
                    if (btn) {
                        btn.classList.add('done');
                        btn.disabled = true;
                    }
                    closePaymentModal();
                    applyFilters();
                    renderTable();
                }
            } catch (e) {
                console.error(e);
            }
        }

        function bindEditableCells() {
            document.querySelectorAll('.editable').forEach(cell => {
                cell.addEventListener('click', function() {
                    const field = this.dataset.field;
                    const id = this.dataset.id;
                    const current = this.textContent.trim();
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = current;
                    input.style.cssText = 'width:100%;padding:4px;font-size:inherit;';
                    this.textContent = '';
                    this.appendChild(input);
                    input.focus();
                    input.addEventListener('blur', () => saveEdit(id, field, input.value, this));
                    input.addEventListener('keydown', e => {
                        if (e.key === 'Enter') { input.blur(); }
                    });
                });
            });
        }

        async function saveEdit(invoiceId, field, value, cell) {
            const body = {};
            body[field] = value;
            try {
                const res = await fetch(API_BASE + '/api/fcfigures/' + encodeURIComponent(invoiceId) + '/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = res.ok ? await res.json().catch(() => ({})) : {};
                if (res.ok) {
                    const row = allRows.find(r => (r.invoice_uuid || r.invoice_id) === invoiceId);
                    if (row) {
                        row[field] = value;
                        if (field === 'current_comments') row.notes = value;
                        if (field === 'consultancy_name') row.vendor_name = value;
                        if (field === 'pay_period_start') row.start_date = value;
                        if (field === 'pay_period_end') row.end_date = value;
                        if (field === 'net_terms') row.payment_terms = value;
                        if (field === 'pay_rate') row.hourly_rate = value;
                        // After approved_hours save, backend returns updated invoice with approval_status, payment_details
                        if (data.invoice) {
                            Object.assign(row, data.invoice);
                            if (data.invoice.invoice_id) row.invoice_uuid = data.invoice.invoice_id;
                        }
                    }
                    cell.textContent = value || '';
                    cell.removeChild(cell.querySelector('input'));
                    bindEditableCells();
                    // Re-render table so status column and View Payment button update
                    if (data.invoice) {
                        applyFilters();
                        renderTable();
                    }
                }
            } catch (e) {
                console.error(e);
                cell.textContent = cell.querySelector('input')?.value || '';
                if (cell.querySelector('input')) cell.removeChild(cell.querySelector('input'));
                bindEditableCells();
            }
        }

        function escapeHtml(s) {
            if (s == null) return '';
            const d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }

        function formatDate(d) {
            if (!d) return '';
            const s = String(d).slice(0, 10);
            return s || '';
        }

        function formatDateTime(d) {
            if (!d) return '';
            const s = String(d);
            return s.length > 19 ? s.slice(0, 19) : s;
        }

        function formatNumber(n) {
            const num = parseFloat(n);
            return isNaN(num) ? '' : num.toLocaleString();
        }

        function toggleSelectAll() {
            const checked = document.getElementById('selectAll').checked;
            document.querySelectorAll('.row-select').forEach(cb => { cb.checked = checked; });
            document.querySelectorAll('.row-delete-btn').forEach(btn => btn.classList.toggle('show', checked));
        }

        function bindRowSelectDelete() {
            document.querySelectorAll('.row-select').forEach(cb => {
                cb.addEventListener('change', function() {
                    const td = this.closest('td');
                    const delBtn = td && td.querySelector('.row-delete-btn');
                    if (delBtn) delBtn.classList.toggle('show', this.checked);
                });
            });
            document.querySelectorAll('.row-delete-btn').forEach(btn => {
                btn.onclick = function(e) {
                    e.stopPropagation();
                    const id = this.dataset.id;
                    if (id) deleteRow(id, e);
                };
            });
        }

        function logout() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }

        function getSelectedIds() {
            return [...document.querySelectorAll('.row-select:checked')].map(cb => cb.dataset.id).filter(Boolean);
        }

        async function deleteRow(invoiceId, ev) {
            if (ev) ev.stopPropagation();
            const label = (allRows.find(r => (r.invoice_uuid || r.invoice_id) === invoiceId)?.doc_name || invoiceId).toString();
            if (!confirm('Delete invoice "' + label + '"? This will remove it from the database.')) return;
            try {
                const res = await fetch(API_BASE + '/api/invoices/' + encodeURIComponent(invoiceId), { method: 'DELETE' });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error(data.error || res.statusText);
                loadDashboard();
            } catch (err) {
                console.error('Delete failed:', err);
                alert('Delete failed: ' + (err.message || 'Please try again.'));
            }
        }

        async function deleteSelectedRows() {
            const ids = getSelectedIds();
            if (!ids.length) { alert('Select at least one row to delete.'); return; }
            if (!confirm('Delete ' + ids.length + ' selected invoice(s)? They will be removed from the database.')) return;
            let deleted = 0;
            for (const id of ids) {
                try {
                    const res = await fetch(API_BASE + '/api/invoices/' + encodeURIComponent(id), { method: 'DELETE' });
                    if (res.ok) deleted++;
                } catch (e) { console.error('Delete failed for', id, e); }
            }
            if (deleted > 0) loadDashboard();
        }

        function generateDailySummary() {
            alert('Generate Daily Summary is a placeholder. Implement based on your requirements.');
        }

        function downloadExcel() {
            if (excelUrl) {
                window.open(excelUrl, '_blank');
            } else {
                // Fallback: export filtered rows as CSV
                const headers = ['S.No','ID','Doc Name','Invoice No','Consultancy Name','Resource Name','Pay Period Start','Pay Period End','Net Terms','Vendor Hours','Approved Hours','Status','Pay Rate','Invoice Amount','Date Inv Recd','Due Date','Project Name','Payment initiated on'];
                const rows = filteredRows.map((r, i) => [
                    i + 1, 
                    r.invoice_uuid || r.invoice_id, 
                    r.doc_name, 
                    r.invoice_number,
                    r.vendor_name || r.consultancy_name, 
                    r.resource_name,
                    r.division||'', 
                    r.client_name||'',
                    r.pay_period_start || '', 
                    r.pay_period_end || '', 
                    r.net_terms || '',
                    r.vendor_hours ?? r.invoice_hours ?? '', 
                    r.approved_hours ?? '', 
                    r.approval_status || r.status || 'Pending',
                    r.pay_rate ?? '',
                    r.invoice_amount ?? '',
                    r.invoice_received_date || r.date_inv_recd || r.created_at || '',
                    r.due_date || r.dueDate || '',
                    r.project_name || '', 
                    r.project_name_excel || '',
                    r.bill_pay_initiated_on ? (r.bill_pay_initiated_on.toString().slice(0, 19)) : ''
                ]);
                const csv = [headers.join(','), ...rows.map(r => r.map(c => '"' + String(c).replace(/"/g, '""') + '"').join(','))].join('\r\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'invoices_' + new Date().toISOString().slice(0, 10) + '.csv';
                a.click();
                URL.revokeObjectURL(a.href);
            }
        }

        document.getElementById('filterAll').addEventListener('change', () => { updateTileActiveState(); applyFilters(); renderTable(); });
        document.getElementById('dueBy').addEventListener('change', () => { applyFilters(); renderTable(); });

        document.getElementById('tableBody').addEventListener('click', function(e) {
            const btn = e.target.closest('.btn-view');
            if (btn) viewDocument(btn.dataset.id, btn.dataset.name);
        });
        
        // View Document - fetch as blob and render with PDF.js
        async function viewDocument(docId, fileName) {
            currentDocId   = docId;
            currentDocName = fileName;

            document.getElementById('viewerFileName').textContent = fileName;
            document.getElementById('pdfContainer').innerHTML      = '<p style="color:#fff; padding:40px; text-align:center;">Loading...</p>';
            document.getElementById('viewerOverlay').style.display = 'flex';

            try {
                const API_BASE = (window.APP_CONFIG && window.APP_CONFIG.apiBaseUrl) || '';
                const response = await fetch(API_BASE + '/api/getdata', {
                    method:  'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userEmail,
                        accessToken,
                        action:     'stream',
                        documentId: docId,
                    })
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`Server error ${response.status}: ${errText}`);
                }

                const blob     = await response.blob();
                const pdfBlob  = new Blob([blob], { type: 'application/pdf' });
                
                if (currentBlobUrl) URL.revokeObjectURL(currentBlobUrl);
                currentBlobUrl = URL.createObjectURL(pdfBlob);

                const arrayBuffer = await pdfBlob.arrayBuffer();
                await renderPDF(arrayBuffer);

            }   catch (err) {
            console.error('viewDocument error:', err);
            document.getElementById('pdfContainer').innerHTML =
                `<p style="color:#ffcccc; padding:40px; text-align:center;">Failed to load: ${err.message}</p>`;
            }
        }

        //Render PDF using PDF.js
        async function renderPDF(arrayBuffer) {
            const container = document.getElementById('pdfContainer');
            container.innerHTML = '<p style="color:#fff; padding:40px; text-align:center;">Rendering pages...</p>';

            try {
            pdfjsLib.GlobalWorkerOptions.workerSrc =
                'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            container.innerHTML = '';

            for (let i = 1; i <= pdf.numPages; i++) {
                const page     = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 1.5 });

                const canvas   = document.createElement('canvas');
                canvas.width   = viewport.width;
                canvas.height  = viewport.height;
                canvas.style.cssText = 'box-shadow:0 2px 8px rgba(0,0,0,0.4); max-width:100%; display:block;';

                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                container.appendChild(canvas);
            }

        } catch (err) {
            console.error('renderPDF error:', err);
            container.innerHTML =
                `<p style="color:#ffcccc; padding:40px; text-align:center;">Failed to render PDF: ${err.message}</p>`;
        }
    
    }

        //Download the PDF file
        function triggerDownload() {
            if (!currentBlobUrl) return;
            const a    = document.createElement('a');
            a.href     = currentBlobUrl;
            a.download = currentDocName || 'document.pdf';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        //Close Viewer and cleanup
       function closeViewer() {
        document.getElementById('viewerOverlay').style.display = 'none';
        document.getElementById('pdfContainer').innerHTML      = '';
        if (currentBlobUrl) {
            URL.revokeObjectURL(currentBlobUrl);
            currentBlobUrl = null;
        }
        currentDocId   = null;
        currentDocName = null;
    }

        //Viewer button listeners
        document.getElementById('btnDownload').addEventListener('click', triggerDownload);
        document.getElementById('btnClose').addEventListener('click', closeViewer);

        document.getElementById('viewerOverlay').addEventListener('click', function(e) {
            if (e.target === this) closeViewer();
        });

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeViewer();
        });

        function escapeAttr(str) {
        return String(str).replace(/'/g, "\\'");
    }
        //Excel File Sync
        async function onSyncFileChosen(input) {
            closeHeaderMenu();
            const file = input.files && input.files[0];
            input.value = '';          // reset so the same file can be chosen again
            if (!file) return;

            if (!file.name.match(/\.xlsx?$/i)) {
                showToast('Invalid file', 'Please upload an .xlsx or .xls file.', 'error');
                return;
            }

            showToast('Uploadingâ€¦', `Processing "${file.name}". This may take a few seconds.`, '');

            try {
                const formData = new FormData();
                formData.append('file', file, file.name);

                // Pass filename as query param so the Function can use it for SharePoint path
                const url = `${API_BASE}/api/sync-excel?filename=${encodeURIComponent(file.name)}`;

                const res  = await fetch(url, {
                    method: 'POST',
                    body: formData
                });
                const data = res.ok ? await res.json().catch(() => ({})) : {};

                if (!res.ok) throw new Error(data.error || `Server error ${res.status}`);

                renderSyncResults(data);
                showToast('Sync complete', buildSyncSummaryText(data), 'success', 8000);
                await loadDashboard();

            } catch (err) {
                console.error('Sync error:', err);
                showToast('Sync failed', err.message || 'Unknown error. Check console.', 'error', 8000);
            }
        }

        function buildSyncSummaryText(d) {
            const parts = [];
            if (d.matched)             parts.push(`âœ… ${d.matched} updated`);
            if (d.need_approval)       parts.push(`âš ï¸ ${d.need_approval} need approval`);
            if (d.pending)             parts.push(`â³ ${d.pending} pending`);
            if (d.unmatched)           parts.push(`âŒ ${d.unmatched} unmatched`);
            if (d.ambiguous)           parts.push(`ðŸ”€ ${d.ambiguous} ambiguous`);
            if (d.skipped_not_pending) parts.push(`â­ ${d.skipped_not_pending} skipped (not Pending)`);
            return parts.join('  Â·  ') || 'No records processed.';
        }

        function renderSyncResults(d) {
            const panel = document.getElementById('syncResultsPanel');
            if (!d || !d.processed) { panel.style.display = 'none'; return; }

            const statPill = (n, label, cls) =>
                n ? `<span class="sync-stat ${cls}">${n} ${label}</span>` : '';

            panel.innerHTML = `
                <div class="sync-results-title">
                    Last sync: ${new Date().toLocaleString()} â€” ${d.processed} person-months processed
                </div>
                ${statPill(d.matched,             'Updated',          'green')}
                ${statPill(d.need_approval,       'Need Approval',    'amber')}
                ${statPill(d.pending,             'Pending',          'blue')}
                ${statPill(d.skipped_not_pending, 'Skipped',          'grey')}
                ${statPill(d.unmatched,           'Unmatched',        'red')}
                ${statPill(d.ambiguous,           'Ambiguous',        'red')}
            `;
            panel.style.display = 'block';
        }

        // â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let _toastTimer = null;
        function showToast(title, body, type = '', duration = 0) {
            const el = document.getElementById('toast');
            el.className = 'toast show' + (type ? ` ${type}` : '');
            document.getElementById('toastTitle').textContent = title;
            document.getElementById('toastBody').textContent  = body;
            if (_toastTimer) clearTimeout(_toastTimer);
            if (duration > 0) _toastTimer = setTimeout(hideToast, duration);
        }
        function hideToast() {
            document.getElementById('toast').classList.remove('show');
        }

    </script>
</body>
</html>
